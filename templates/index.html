<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/css/style.css">
    <title>Banking Bot</title>
  
</head>
<body>

<div class="container">
        <div class="col-4"><div class="chat-header">
            <a href="#" class="logo">

<img src="static/logo.png" alt="">

            </a>
    </div></div>
    <div class="col-4">
        <div class="chat-container">

    <div class="chat-box" id="chat-box">
        <!-- Messages will appear here -->
        <!-- <div class="message bot-msg intro">Hello! How can I help you today?</div> -->
        <div class=" intro">
                <!-- Initial Message from Server Logic -->
                <div class="intro-container">
                    <h1 class="intro">{{ initial_message }}</h1>
                </div>
                
                <!-- Initial Options -->
                <div class="options-container" id="options-container">
                    {% for opt in initial_options %}
                        <button class="option-btn" onclick="handleOptionClick('{{ opt.label }}', '{{ opt.next_step }}')">
                            {{ opt.label }}
                        </button>
                    {% endfor %}
                </div>
        </div>
    </div>
   <div class="chat-bottom">
     <div class="input-area">
        <input type="text" id="user-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
        <a onclick="sendMessage()" id="send-btn"  >
            
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M14.4297 5.92969L20.4997 11.9997L14.4297 18.0697" stroke="white" stroke-width="2.3" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M3.5 12H20.33" stroke="white" stroke-width="2.3" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

        </a>
    </div>
   </div>
</div>
    </div>
        <div class="col-4"> </div>
</div>


<script>
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    // 1. Handle Button Clicks (CSV Flow)
    async function handleOptionClick(label, nextStepId) {
        // If it's a URL, open it
        if (nextStepId.startsWith("http")) {
            window.open(nextStepId, '_blank');
            return;
        }

        // Add User Selection to Chat
        addMessage(label, 'user-msg');
        
        // Remove old buttons to prevent re-clicking
        removeOldButtons();

        // Send request to backend with specific Step ID
        await fetchResponse({ current_step_id: nextStepId });
    }

    // 2. Handle Text Input (AI Flow)
    async function sendTextMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        addMessage(text, 'user-msg');
        userInput.value = "";
        toggleSendBtn();

        // Remove old buttons if user decides to type instead
        removeOldButtons();

        // Send request with message text
        await fetchResponse({ message: text });
    }

    // Core Fetch Logic
    async function fetchResponse(payload) {
        // Show typing indicator (optional)
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "message bot-msg loading";
        loadingDiv.innerText = "Is typing...";
        chatBox.appendChild(loadingDiv);

        try {
            const response = await fetch('chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();

            // Remove loading
            chatBox.removeChild(loadingDiv);

            // Add Bot Message
            addMessage(data.response, 'bot-msg');

            // Render Options if available
            if (data.options && data.options.length > 0) {
                renderOptions(data.options);
            }

        } catch (error) {
            if(loadingDiv.parentNode) chatBox.removeChild(loadingDiv);
            addMessage("Network Error. Please try again.", 'bot-msg');
        }
    }

    function addMessage(text, className) {
        const div = document.createElement("div");
        div.classList.add("message", className);
        div.innerText = text; // Secure text insertion
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function renderOptions(options) {
        const container = document.createElement("div");
        container.className = "options-container active-options";
        
        options.forEach(opt => {
            const btn = document.createElement("button");
            btn.className = "option-btn";
            btn.innerText = opt.label;
            btn.onclick = () => handleOptionClick(opt.label, opt.next_step);
            container.appendChild(btn);
        });
        
        chatBox.appendChild(container);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function removeOldButtons() {
        const oldContainers = document.querySelectorAll('.active-options');
        oldContainers.forEach(el => el.remove());
        
        // Also remove the initial jinja rendered buttons if they exist
        const initOpts = document.getElementById("options-container");
        if(initOpts) initOpts.style.display = 'none';
    }

    function handleEnter(event) {
        if (event.key === "Enter") sendTextMessage();
    }

    function toggleSendBtn() {
        if (userInput.value.trim() === "") {
            sendBtn.classList.add("disabled");
        } else {
            sendBtn.classList.remove("disabled");
        }
    }

    userInput.addEventListener("input", toggleSendBtn);
</script>


</body>
</html>
